<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Paex360 - Acceso</title>
  <link rel="icon" href="paex360-logo.png" type="image/png">

  <style>
    :root{
      --bg: #f3f2f0;
      --card: #ffffff;
      --text: #111827;
      --muted:#6b7280;
      --danger:#dc2626;
      --primary:#111827;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --radius: 14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }

    .wrap{
      width: min(1100px, 100%);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .brand img{
      height: 34px;
      width: 34px;
      border-radius: 10px;
      object-fit: cover;
    }

    .brand h1{
      font-size: 16px;
      margin: 0;
      font-weight: 700;
      letter-spacing: .2px;
    }

    .userbar{
      display:flex;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 13px;
    }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding: 10px 12px;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .btn-primary{
      background: var(--primary);
      color:#fff;
      border-color: var(--primary);
    }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
    }

    .title{
      margin:0 0 8px 0;
      font-size: 18px;
      font-weight: 800;
    }

    .subtitle{
      margin:0 0 20px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    @media(max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 12px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    input{
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      outline:none;
      font-size: 14px;
      background:#fff;
    }
    input:focus{
      border-color: #9ca3af;
    }

    .error{
      color: var(--danger);
      font-size: 13px;
      font-weight: 700;
      margin-top: 8px;
    }

    .centros{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .centro-btn{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
    }
    .centro-btn:hover{
      border-color: #9ca3af;
    }

    .notice{
      margin-top: 10px;
      color: var(--danger);
      font-weight: 800;
      font-size: 13px;
    }

    .divider{
      height:1px;
      background: var(--border);
      margin: 14px 0;
    }

    .iframe-wrap{
      margin-top: 14px;
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      height: 640px;
      background:#fff;
      display:none;
    }
    iframe{
      width:100%;
      height:100%;
      border:0;
    }

    .small{
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <img src="paex360-logo.png" alt="Paex360">
        <h1>Paex360</h1>
      </div>

      <div class="userbar">
        <span id="userEmail"></span>
        <button class="btn" id="logoutBtn" style="display:none;">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="card">
      <div class="grid">

        <!-- PANEL LOGIN -->
        <div class="panel" id="loginPanel">
          <h2 class="title">Acceso</h2>
          <p class="subtitle">Inicia sesi√≥n para ver los centros habilitados.</p>

          <div class="field">
            <label for="loginEmail">Correo</label>
            <input id="loginEmail" type="email" placeholder="tu_correo@dominio.com" autocomplete="email">
          </div>

          <div class="field">
            <label for="loginPass">Contrase√±a</label>
            <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          </div>

          <button class="btn btn-primary" id="loginBtn">Ingresar</button>
          <div id="loginError" class="error" style="display:none;"></div>

          <div class="divider"></div>
          <div class="small">
            Si tu usuario existe en Firebase pero no aparece el centro, es porque no tiene permisos en <b>Permisos_pagina.csv</b>.
          </div>
        </div>

        <!-- PANEL SELECCION -->
        <div class="panel" id="centrosPanel" style="display:none;">
          <h2 class="title">Selecciona un centro</h2>
          <p class="subtitle">Se mostrar√°n √∫nicamente los centros autorizados para tu usuario.</p>

          <div id="centros-container" class="centros"></div>
          <div id="mensaje-permisos" class="notice" style="display:none;"></div>

          <div class="iframe-wrap" id="iframeWrap">
            <iframe id="pbiFrame" src=""></iframe>
          </div>

          <div class="small" style="margin-top:10px;">
            Si al hacer clic no carga el tablero, revisa tu function <b>getPowerBI.js</b> (debe devolver una URL).
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Firebase + l√≥gica -->
  <script type="module">
    // =========================
    // 1) Firebase config
    // =========================
    // Opci√≥n A (recomendada): config.js exportando firebaseConfig
    // export const firebaseConfig = { ... }
    let firebaseConfig = null;

    try {
      const cfg = await import("./config.js");
      firebaseConfig = cfg.firebaseConfig || null;
    } catch (e) {
      // Si falla import, intentamos getConfig function (si la tienes)
      try {
        const r = await fetch("/.netlify/functions/getConfig");
        if (r.ok) firebaseConfig = await r.json();
      } catch (e2) {}
    }

    if (!firebaseConfig) {
      alert("No se pudo cargar la configuraci√≥n de Firebase (config.js / getConfig).");
      throw new Error("Missing Firebase config");
    }

    // =========================
    // 2) Firebase SDK (CDN)
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // =========================
    // 3) UI helpers
    // =========================
    const loginPanel = document.getElementById("loginPanel");
    const centrosPanel = document.getElementById("centrosPanel");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginError = document.getElementById("loginError");
    const userEmailEl = document.getElementById("userEmail");

    const centrosContainer = document.getElementById("centros-container");
    const mensajePermisos = document.getElementById("mensaje-permisos");

    const iframeWrap = document.getElementById("iframeWrap");
    const pbiFrame = document.getElementById("pbiFrame");

    function showLogin() {
      loginPanel.style.display = "block";
      centrosPanel.style.display = "none";
      logoutBtn.style.display = "none";
      userEmailEl.textContent = "";
      iframeWrap.style.display = "none";
      pbiFrame.src = "";
    }

    function showCentros(email) {
      loginPanel.style.display = "none";
      centrosPanel.style.display = "block";
      logoutBtn.style.display = "inline-block";
      userEmailEl.textContent = email;
    }

    function setLoginError(msg) {
      loginError.style.display = msg ? "block" : "none";
      loginError.textContent = msg || "";
    }

    function mostrarSinPermisos(texto) {
      centrosContainer.innerHTML = "";
      mensajePermisos.style.display = "block";
      mensajePermisos.textContent = texto;
      iframeWrap.style.display = "none";
      pbiFrame.src = "";
    }

    function limpiarMensajePermisos() {
      mensajePermisos.style.display = "none";
      mensajePermisos.textContent = "";
    }

    // =========================
    // 4) Permissions + render
    // =========================
    async function cargarPermisosYRender(email) {
      const cleanEmail = (email || "").toLowerCase().trim();
      console.log("üîé Email logueado:", cleanEmail);

      if (!cleanEmail) {
        mostrarSinPermisos("No se pudo leer el email del usuario logueado.");
        return;
      }

      let data;
      try {
        const resp = await fetch("/.netlify/functions/getPermissions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: cleanEmail })
        });

        data = await resp.json().catch(() => ({}));
        console.log("‚úÖ Respuesta getPermissions:", data);

        if (!resp.ok) {
          mostrarSinPermisos(data?.error || "No autorizado.");
          return;
        }
      } catch (e) {
        console.error("‚ùå Error llamando getPermissions:", e);
        mostrarSinPermisos("No se pudo consultar permisos (error de red).");
        return;
      }

      const perms = data?.permissions || {};
      const puedeDiagonal = perms.Clinica_Diagonal === true;
      const puedeSalus = perms.Clinica_Salus === true;

      console.log("üéØ Permisos parseados:", { puedeDiagonal, puedeSalus });

      if (!puedeDiagonal && !puedeSalus) {
        mostrarSinPermisos("No tienes permisos para visualizar ning√∫n tablero.");
        return;
      }

      limpiarMensajePermisos();
      renderBotonesCentros({ puedeDiagonal, puedeSalus });
    }

    function renderBotonesCentros({ puedeDiagonal, puedeSalus }) {
      centrosContainer.innerHTML = "";
      iframeWrap.style.display = "none";
      pbiFrame.src = "";

      if (puedeDiagonal) {
        const btn = document.createElement("button");
        btn.className = "centro-btn";
        btn.textContent = "Cl√≠nica Diagonal";
        btn.onclick = () => abrirCentro("diagonal");
        centrosContainer.appendChild(btn);
      }

      if (puedeSalus) {
        const btn = document.createElement("button");
        btn.className = "centro-btn";
        btn.textContent = "Cl√≠nica SALUS";
        btn.onclick = () => abrirCentro("salus");
        centrosContainer.appendChild(btn);
      }
    }

    // =========================
    // 5) Abrir centro (Power BI)
    // =========================
    async function abrirCentro(centerKey) {
      // Intento 1: usar getPowerBI.js (si tu function devuelve URL)
      // Espera algo como: { url: "https://app.powerbi.com/view?r=..." }
      try {
        const r = await fetch(`/.netlify/functions/getPowerBI?center=${encodeURIComponent(centerKey)}`);
        const data = await r.json().catch(() => ({}));

        if (!r.ok) {
          throw new Error(data?.error || "getPowerBI no respondi√≥ OK");
        }

        const url = data.url || data.embedUrl || data.reportUrl || "";
        if (!url) {
          throw new Error("getPowerBI respondi√≥ sin URL (url/embedUrl/reportUrl).");
        }

        iframeWrap.style.display = "block";
        pbiFrame.src = url;
        return;

      } catch (e) {
        console.error("‚ùå Error abriendo centro:", e);
        mostrarSinPermisos("No se pudo cargar el tablero. Revisa getPowerBI.js (debe devolver una URL).");
      }
    }

    // =========================
    // 6) Login / Logout handlers
    // =========================
    loginBtn.addEventListener("click", async () => {
      setLoginError("");

      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPass").value;

      if (!email || !pass) {
        setLoginError("Debes ingresar correo y contrase√±a.");
        return;
      }

      loginBtn.disabled = true;

      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        console.error(e);
        setLoginError("Credenciales inv√°lidas o usuario no existe.");
      } finally {
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      showLogin();
    });

    // =========================
    // 7) Auth state
    // =========================
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        showLogin();
        return;
      }

      showCentros(user.email);
      await cargarPermisosYRender(user.email);
    });

  </script>
</body>
</html>
