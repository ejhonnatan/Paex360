<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PaEx360</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="paex360-logo.png">

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2/dist/powerbi.min.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f3f2f1;
    }

    #auth-container {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-card {
      background: #fff;
      width: 420px;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.12);
      text-align: center;
    }

    .login-card img {
      width: 110px;
      margin-bottom: 20px;
    }

    .login-card input {
      width: 100%;
      padding: 12px;
      margin-top: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .login-card button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      background: #662483;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    .error {
      margin-top: 12px;
      color: #c62828;
      font-size: 13px;
      min-height: 18px;
    }

    #dashboard {
      display: none;
      height: 100%;
      flex-direction: column;
    }

    header {
      height: 48px;
      background: #662483;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
    }

    .profile {
      position: relative;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #fff;
      color: #662483;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      cursor: pointer;
    }

    .menu {
      display: none;
      position: absolute;
      right: 0;
      top: 42px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
      min-width: 260px;
      padding: 6px 0;
      z-index: 9999;
    }

    .menu .email {
      padding: 10px 16px;
      font-size: 13px;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }

    .menu .item {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 14px;
    }

    .menu .item:hover {
      background: #f3f2f1;
    }

    #centerSelector {
      flex: 1;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .center-card {
      width: min(900px, 95vw);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,.10);
      padding: 26px;
    }

    .center-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
    }

    .center-btn {
      border: 1px solid #e6e6e6;
      background: #fafafa;
      border-radius: 12px;
      padding: 18px;
      cursor: pointer;
    }

    .center-btn:hover {
      background: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,.10);
    }

    .no-access {
      color: #c62828;
      font-size: 14px;
      padding: 10px 0;
    }

    #reportContainer {
      flex: 1;
      display: none;
    }
  </style>
</head>

<body>

<div id="auth-container">
  <div class="login-card">
    <img src="paex360-logo.png">
    <input id="email" type="email" placeholder="Correo electrónico">
    <input id="password" type="password" placeholder="Contraseña">
    <button onclick="login()">Ingresar</button>
    <div id="error" class="error"></div>
  </div>
</div>

<div id="dashboard">
  <header>
    <strong id="appTitle">PaEx360</strong>
    <div class="profile">
      <div id="avatar" class="avatar" onclick="toggleMenu()">U</div>
      <div id="menu" class="menu">
        <div id="userEmail" class="email"></div>
        <div class="item" onclick="openCenterSelector()">Cambiar centro</div>
        <div class="item" onclick="logout()">Cerrar sesión</div>
      </div>
    </div>
  </header>

  <div id="centerSelector">
    <div class="center-card">
      <h3>Selecciona un centro</h3>
      <div id="centerGrid" class="center-grid"></div>
      <div id="noAccessMsg" class="no-access" style="display:none;">
        No tienes permisos para visualizar ningún tablero.
      </div>
    </div>
  </div>

  <div id="reportContainer"></div>
</div>

<script>

let auth;

const WORKSPACE_ID = "7230301b-540b-4f1a-b94d-c3ff22d4564d";

const CENTERS = {
  "Salus": { reportId: "be0ed5d8-4753-4dd0-b031-ed0b7ab57d96" },
  "Diagonal": { reportId: "c82cbcf1-7b93-458a-8f14-3b7a86800a23" }
};

async function initFirebase() {
  const r = await fetch("/.netlify/functions/getConfig");
  const cfg = await r.json();

  firebase.initializeApp({
    apiKey: cfg.apiKey,
    authDomain: cfg.authDomain,
    projectId: cfg.projectId
  });

  auth = firebase.auth();

  auth.onAuthStateChanged(async user => {
    if (user) {
      document.getElementById("auth-container").style.display = "none";
      document.getElementById("dashboard").style.display = "flex";

      const email = user.email || "";
      document.getElementById("avatar").textContent = email.charAt(0).toUpperCase();
      document.getElementById("userEmail").textContent = email;

      openCenterSelector();

      const permissions = await fetchPermissionsMap();
      renderCentersForUser(email, permissions);

    } else {
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("auth-container").style.display = "flex";
    }
  });
}

function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  document.getElementById("error").textContent = "";

  if (!auth) return;

  auth.signInWithEmailAndPassword(email, password)
    .catch(() => {
      document.getElementById("error").textContent = "Usuario o contraseña incorrectos";
    });
}

function logout() {
  if (auth) auth.signOut();
}

function toggleMenu() {
  const menu = document.getElementById("menu");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function openCenterSelector() {
  document.getElementById("menu").style.display = "none";
  document.getElementById("reportContainer").style.display = "none";
  document.getElementById("centerSelector").style.display = "flex";
  document.getElementById("appTitle").textContent = "PaEx360";
}

function selectCenter(centerName) {
  document.getElementById("centerSelector").style.display = "none";
  document.getElementById("reportContainer").style.display = "block";
  document.getElementById("appTitle").textContent = `PaEx360 · ${centerName}`;
  loadPowerBI(CENTERS[centerName].reportId);
}

async function fetchPermissionsMap() {
  const r = await fetch("/.netlify/functions/getPermissions");
  return await r.json();
}

function renderCentersForUser(email, permissions) {
  const grid = document.getElementById("centerGrid");
  const noAccess = document.getElementById("noAccessMsg");

  grid.innerHTML = "";
  noAccess.style.display = "none";

  const key = email.toLowerCase();
  const allowed = permissions[key] || [];

  if (allowed.length === 0) {
    noAccess.style.display = "block";
    return;
  }

  allowed.forEach(center => {
    if (!CENTERS[center]) return;

    const div = document.createElement("div");
    div.className = "center-btn";
    div.onclick = () => selectCenter(center);
    div.innerHTML = `<strong>${center}</strong><br>Abrir tablero`;
    grid.appendChild(div);
  });
}

async function loadPowerBI(reportId) {
  const container = document.getElementById("reportContainer");
  powerbi.reset(container);

  const r = await fetch("/.netlify/functions/getPowerBI", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      workspaceId: WORKSPACE_ID,
      reportId
    })
  });

  const data = await r.json();

  if (!r.ok) {
    alert(data?.error || "Error cargando Power BI");
    return;
  }

  const models = window["powerbi-client"].models;

  powerbi.embed(container, {
    type: "report",
    id: data.reportId,
    embedUrl: data.embedUrl,
    accessToken: data.embedToken,
    tokenType: models.TokenType.Embed,
    permissions: models.Permissions.Read
  });
}

initFirebase();

</script>

</body>
</html>
